<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sawada Trader - Central de Ferramentas</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Optional: Custom scrollbar styles for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e0; /* gray-300 */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a0aec0; /* gray-400 */
        }

        /* Base styles for page display */
        .page-content {
            display: none; /* All content pages are hidden by default */
        }
        .page-content.active {
            display: block; /* Active page is displayed */
        }

        /* --- Avaliador App Specific Styles (from provided code) --- */
        /* Importa√ß√£o de fonte do Google Fonts (opcional, mas melhora a tipografia) */
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap');

        :root {
            --primary-color: #4CAF50; /* Verde vibrante */
            --secondary-color: #2196F3; /* Azul para bot√µes secund√°rios */
            --accent-color: #FFC107; /* Amarelo para destaque/aviso */
            --danger-color: #F44336; /* Vermelho para a√ß√µes de perigo */
            --text-color: #333;
            --light-bg: #F8F9FA; /* Fundo claro */
            --dark-bg: #E9ECEF; /* Fundo mais escuro para se√ß√µes */
            --border-color: #DEE2E6; /* Cor de borda suave */
            --shadow-light: 0 4px 8px rgba(0, 0, 0, 0.05);
            --shadow-medium: 0 6px 12px rgba(0, 0, 0, 0.1);
        }

        #avaliador-page .container-avaliador { /* Renamed to avoid conflict */
            background-color: #ffffff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: var(--shadow-medium);
            width: 100%;
            max-width: 700px; /* Ajustado para o tamanho do pr√©-check */
            box-sizing: border-box;
            margin: 0 auto; /* Center the container */
        }

        #avaliador-page h1, #avaliador-page h2, #avaliador-page h3 {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 25px;
            font-weight: 500;
        }

        #avaliador-page h1 {
            font-size: 2.5em;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 15px;
            margin-bottom: 35px;
            color: #333; /* Cor mais neutra para o t√≠tulo principal */
        }

        #avaliador-page h2 {
            font-size: 1.8em;
            color: var(--secondary-color);
            margin-bottom: 25px;
            border-bottom: 1px dashed var(--border-color);
            padding-bottom: 10px;
        }

        #avaliador-page .section {
            margin-bottom: 35px;
            padding: 25px;
            border-radius: 10px;
            background-color: var(--light-bg);
            box-shadow: var(--shadow-light);
        }

        #avaliador-page .card {
            border: 1px solid var(--border-color);
        }

        #avaliador-page .input-group {
            margin-bottom: 18px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 15px; /* Mais espa√ßo */
        }

        #avaliador-page .input-group label {
            flex: 1 1 180px; /* Ajusta a largura m√≠nima da label */
            color: var(--text-color);
            font-weight: 400;
            font-size: 1.05em;
        }

        #avaliador-page .input-field {
            flex: 2 1 250px; /* Ajusta a largura m√≠nima do input */
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 1em;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        #avaliador-page .input-field:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.2);
            outline: none;
        }

        #avaliador-page textarea.input-field {
            resize: vertical;
            min-height: 80px;
        }

        #avaliador-page .checkbox-group {
            align-items: center; /* Alinha checkbox e label na mesma linha */
        }

        #avaliador-page .checkbox-group input[type="checkbox"] {
            transform: scale(1.3); /* Aumenta o tamanho do checkbox */
            margin-right: 10px; /* Espa√ßo entre checkbox e label */
        }

        /* Bot√µes */
        #avaliador-page .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.05em;
            font-weight: 500;
            transition: background-color 0.3s ease, transform 0.1s ease, box-shadow 0.3s ease;
            width: 100%;
            margin-top: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        #avaliador-page .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        #avaliador-page .btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        #avaliador-page .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        #avaliador-page .btn-primary:hover {
            background-color: #43A047; /* Um pouco mais escuro */
        }
        
        #avaliador-page .suggestion {
            margin-top: 25px;
            padding: 15px;
            border-radius: 8px;
            font-weight: 500;
            text-align: center;
            font-size: 1.1em;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
        }

        #avaliador-page .suggestion.green {
            background-color: #E8F5E9; /* Verde claro */
            color: #2E7D32; /* Verde escuro */
            border: 1px solid #66BB6A;
        }

        #avaliador-page .suggestion.red {
            background-color: #FFEBEE; /* Vermelho claro */
            color: #C62828; /* Vermelho escuro */
            border: 1px solid #EF5350;
        }

        #avaliador-page .suggestion.orange {
            background-color: #FFF8E1; /* Amarelo claro */
            color: #FF8F00; /* Laranja escuro */
            border: 1px solid #FFD54F;
        }
        
        /* Responsividade */
        @media (max-width: 768px) {
            #avaliador-page .container-avaliador {
                padding: 20px;
            }
            #avaliador-page h1 {
                font-size: 2em;
            }
            #avaliador-page h2 {
                font-size: 1.5em;
            }
            #avaliador-page .input-group {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            #avaliador-page .input-group label,
            #avaliador-page .input-field {
                width: 100%;
                flex: auto;
            }
            #avaliador-page .btn {
                padding: 10px 15px;
                font-size: 0.95em;
            }
        }

        /* Projetor App Specific Styles */
        #projetor-page .result-table-container {
            overflow-x: auto; /* Enable horizontal scrolling for the table on small screens */
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
            padding-bottom: 10px; /* Space for scrollbar */
        }

        #projetor-page table {
            width: 100%;
            border-collapse: collapse;
        }

        #projetor-page th, #projetor-page td {
            border: 1px solid #e2e8f0; /* Tailwind's gray-200 */
            padding: 12px 16px;
            text-align: left;
            font-size: 0.9rem;
        }

        #projetor-page thead th {
            background-color: #edf2f7; /* Tailwind's gray-100 */
            font-weight: 600;
            color: #2d3748; /* Tailwind's gray-800 */
            white-space: nowrap; /* Prevent headers from wrapping */
        }

        #projetor-page tbody tr:nth-child(even) {
            background-color: #f7fafc; /* Tailwind's gray-50 */
        }

        #projetor-page tbody tr:hover {
            background-color: #ebf8ff; /* Tailwind's blue-50 */
        }

        /* Specific styles for text-muted similar to the original site */
        #projetor-page .form-text.text-muted {
            font-size: 0.875rem; /* text-sm */
            color: #6b7280; /* gray-500 */
            margin-top: 0.25rem; /* mt-1 */
            margin-bottom: 0;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans antialiased text-gray-900 p-4 sm:p-6 lg:p-8">

    <div class="max-w-6xl mx-auto bg-white shadow-xl rounded-xl p-6 sm:p-8">
        <!-- Message Box (Global for all apps) -->
        <div id="message-box" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white p-6 rounded-lg shadow-lg max-w-sm text-center">
                <p id="message-content" class="text-lg font-semibold mb-4"></p>
                <div class="flex justify-center">
                    <button
                        id="message-ok-button"
                        class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105"
                    >
                        OK
                    </button>
                    <button
                        id="message-cancel-button"
                        class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 ml-4 hidden"
                    >
                        Cancelar
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Page: Sawada Trader Home -->
        <div id="home-page" class="page-content active">
            <h1 class="text-5xl font-extrabold text-indigo-800 mb-4 text-center">
                üëã Sawada Trader
            </h1>
            <p class="text-center text-gray-700 mb-8 text-lg">
                Bem-vindo √† sua central de ferramentas de trading.
            </p>
            <p id="app-version" class="text-center text-gray-500 text-sm mb-12">
                Vers√£o: 
            </p>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
                <button
                    id="btn-estatistica"
                    class="bg-green-600 hover:bg-green-700 text-white font-bold py-6 px-8 rounded-lg shadow-lg text-2xl transition duration-300 ease-in-out transform hover:scale-105"
                >
                    üìä Estatistica
                </button>
                <button
                    id="btn-expectativa"
                    class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-6 px-8 rounded-lg shadow-lg text-2xl transition duration-300 ease-in-out transform hover:scale-105"
                >
                    üìà Expectativa
                </button>
                <button
                    id="btn-avaliador"
                    class="bg-red-600 hover:bg-red-700 text-white font-bold py-6 px-8 rounded-lg shadow-lg text-2xl transition duration-300 ease-in-out transform hover:scale-105"
                >
                    üß† Avaliador
                </button>
                <button
                    id="btn-projetor"
                    class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-6 px-8 rounded-lg shadow-lg text-2xl transition duration-300 ease-in-out transform hover:scale-105"
                >
                    üí∞ Projetor
                </button>
            </div>
        </div>

        <!-- Estatistica App Section -->
        <div id="estatistica-page" class="page-content">
            <h1 class="text-4xl font-extrabold text-blue-800 mb-6 text-center">
                üìä Estatistica - Seu Painel de Day Trade
            </h1>
            <button id="estatistica-btn-home" class="mb-6 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                ‚Üê Voltar ao In√≠cio
            </button>
            <p class="text-center text-gray-600 mb-8">
                Registe e monitorize a performance di√°ria/noturna das suas opera√ß√µes.
            </p>

            <!-- Adicionar Nova Opera√ß√£o Section -->
            <div class="mb-10 p-6 bg-blue-50 rounded-lg shadow-md">
                <h2 class="text-2xl font-bold text-blue-700 mb-5 text-center">Adicionar Nova Opera√ß√£o</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="dataInput" class="block text-sm font-medium text-gray-700 mb-1">Data</label>
                        <input
                            type="date"
                            id="dataInput"
                            class="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                        />
                    </div>
                    <div class="flex flex-col">
                        <label for="valorRiscoInput" class="block text-sm font-medium text-gray-700 mb-1">Valor do Risco (R)</label>
                        <input
                            type="number"
                            id="valorRiscoInput"
                            value="1"
                            step="0.01"
                            class="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                        />
                    </div>
                    <div class="flex flex-col">
                        <label for="riscoRecompensaInput" class="block text-sm font-medium text-gray-700 mb-1">Risco/Recompensa (Ganho: 3R, Perda: 1R)</label>
                        <input
                            type="number"
                            id="riscoRecompensaInput"
                            value="3"
                            step="0.01"
                            class="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                        />
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6">
                    <!-- Turno do Dia -->
                    <fieldset class="border p-4 rounded-md shadow-sm">
                        <legend class="text-lg font-medium text-gray-900 px-2">Turno do Dia</legend>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mt-2">
                            <div>
                                <label for="winDayInput" class="block text-sm font-medium text-gray-700 mb-1">WIN</label>
                                <input type="number" id="winDayInput" value="0" class="mt-1 block w-full p-3 border border-gray-300 rounded-md" />
                            </div>
                            <div>
                                <label for="lossDayInput" class="block text-sm font-medium text-gray-700 mb-1">LOSS</label>
                                <input type="number" id="lossDayInput" value="0" class="mt-1 block w-full p-3 border border-gray-300 rounded-md" />
                            </div>
                            <div>
                                <label for="breakEvenDayInput" class="block text-sm font-medium text-gray-700 mb-1">BREAKEVEN</label>
                                <input type="number" id="breakEvenDayInput" value="0" class="mt-1 block w-full p-3 border border-gray-300 rounded-md" />
                            </div>
                        </div>
                    </fieldset>

                    <!-- Turno da Noite -->
                    <fieldset class="border p-4 rounded-md shadow-sm">
                        <legend class="text-lg font-medium text-gray-900 px-2">Turno da Noite</legend>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mt-2">
                            <div>
                                <label for="winNightInput" class="block text-sm font-medium text-gray-700 mb-1">WIN</label>
                                <input type="number" id="winNightInput" value="0" class="mt-1 block w-full p-3 border border-gray-300 rounded-md" />
                            </div>
                            <div>
                                <label for="lossNightInput" class="block text-sm font-medium text-gray-700 mb-1">LOSS</label>
                                <input type="number" id="lossNightInput" value="0" class="mt-1 block w-full p-3 border border-gray-300 rounded-md" />
                            </div>
                            <div>
                                <label for="breakEvenNightInput" class="block text-sm font-medium text-gray-700 mb-1">BREAKEVEN</label>
                                <input type="number" id="breakEvenNightInput" value="0" class="mt-1 block w-full p-3 border border-gray-300 rounded-md" />
                            </div>
                        </div>
                    </fieldset>
                </div>

                <!-- Calculated Metrics -->
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mt-6">
                    <div class="p-3 bg-white rounded-md shadow-sm">
                        <p class="text-sm font-medium text-gray-700">Saldo Calculado</p>
                        <p id="saldoCalculadoDisplay" class="text-lg font-bold text-gray-900 mt-1">R0.00</p>
                    </div>
                    <div class="p-3 bg-white rounded-md shadow-sm">
                        <p class="text-sm font-medium text-gray-700">Total de Trades</p>
                        <p id="totalTradesCalculadoDisplay" class="text-lg font-bold text-gray-900 mt-1">0</p>
                    </div>
                    <div class="p-3 bg-white rounded-md shadow-sm">
                        <p class="text-sm font-medium text-gray-700">Taxa de Acerto</p>
                        <p id="taxaAcertoCalculadoDisplay" class="text-lg font-bold text-gray-900 mt-1">0.00%</p>
                    </div>
                </div>

                <div class="mt-8 flex flex-col sm:flex-row gap-4">
                    <button
                        id="estatistica-add-edit-button"
                        class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition duration-300 ease-in-out transform hover:scale-105"
                    >
                        Adicionar Opera√ß√£o
                    </button>
                    <button
                        id="estatistica-cancel-edit-button"
                        class="flex-1 bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition duration-300 ease-in-out transform hover:scale-105 hidden"
                    >
                        Cancelar Edi√ß√£o
                    </button>
                    <button
                        id="estatistica-export-button"
                        class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition duration-300 ease-in-out transform hover:scale-105"
                    >
                        Exportar Dados (JSON)
                    </button>
                    <input
                        type="file"
                        id="estatistica-import-input"
                        accept=".json"
                        class="hidden"
                    />
                    <button
                        id="estatistica-import-button"
                        class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition duration-300 ease-in-out transform hover:scale-105"
                    >
                        Importar Dados (JSON)
                    </button>
                </div>
            </div>

            <div class="mb-10 p-6 bg-green-50 rounded-lg shadow-md">
                <h2 class="text-2xl font-bold text-green-700 mb-5 text-center">Resumo Mensal</h2>
                <div id="monthlySummaries" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    </div>
            </div>

            <div class="mb-10 p-6 bg-yellow-50 rounded-lg shadow-md">
                <h2 class="text-2xl font-bold text-yellow-700 mb-5 text-center">Trades Detalhados do M√™s</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white rounded-lg shadow-md">
                        <thead>
                            <tr class="bg-yellow-100">
                                <th class="py-3 px-4 text-left text-sm font-medium text-gray-700 uppercase cursor-pointer" data-sort="data">Data <span class="sort-icon"></span></th>
                                <th class="py-3 px-4 text-left text-sm font-medium text-gray-700 uppercase cursor-pointer" data-sort="winDay">WINd <span class="sort-icon"></span></th>
                                <th class="py-3 px-4 text-left text-sm font-medium text-gray-700 uppercase cursor-pointer" data-sort="lossDay">LOSSd <span class="sort-icon"></span></th>
                                <th class="py-3 px-4 text-left text-sm font-medium text-gray-700 uppercase cursor-pointer" data-sort="breakEvenDay">BREAKEVENd <span class="sort-icon"></span></th>
                                <th class="py-3 px-4 text-left text-sm font-medium text-gray-700 uppercase cursor-pointer" data-sort="winNight">WINn <span class="sort-icon"></span></th>
                                <th class="py-3 px-4 text-left text-sm font-medium text-gray-700 uppercase cursor-pointer" data-sort="lossNight">LOSSn <span class="sort-icon"></span></th>
                                <th class="py-3 px-4 text-left text-sm font-medium text-gray-700 uppercase cursor-pointer" data-sort="breakEvenNight">BREAKEVENn <span class="sort-icon"></span></th>
                                <th class="py-3 px-4 text-left text-sm font-medium text-gray-700 uppercase cursor-pointer" data-sort="totalTrades">TOTAL TRADE <span class="sort-icon"></span></th>
                                <th class="py-3 px-4 text-left text-sm font-medium text-gray-700 uppercase cursor-pointer" data-sort="taxaAcerto">TAXA ACERTO <span class="sort-icon"></span></th>
                                <th class="py-3 px-4 text-left text-sm font-medium text-gray-700 uppercase cursor-pointer" data-sort="saldo">SALDO <span class="sort-icon"></span></th>
                                <th class="py-3 px-4 text-left text-sm font-medium text-gray-700 uppercase cursor-pointer" data-sort="valorRisco">Valor R <span class="sort-icon"></span></th>
                                <th class="py-3 px-4 text-left text-sm font-medium text-gray-700 uppercase cursor-pointer" data-sort="riscoRecompensa">R/R <span class="sort-icon"></span></th>
                                <th class="py-3 px-4 text-left text-sm font-medium text-gray-700 uppercase">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="tradeDetailsTableBody">
                            </tbody>
                    </table>
                </div>
            </div>

            <div class="mb-10 p-6 bg-red-50 rounded-lg shadow-md">
                <h2 class="text-2xl font-bold text-red-700 mb-5 text-center">Resumo Total</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="totalSummary">
                    </div>
                <button
                    id="estatistica-reset-all-button"
                    class="mt-8 w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition duration-300 ease-in-out transform hover:scale-105"
                >
                    Redefinir Tudo
                </button>
            </div>
        </div>

        <!-- Expectativa App Section -->
        <div id="expectativa-page" class="page-content">
            <h1 class="text-4xl font-extrabold text-blue-800 mb-6 text-center">
                üìà Expectativa - Avaliador de Estrat√©gias
            </h1>
            <button id="expectativa-btn-home" class="mb-6 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                ‚Üê Voltar ao In√≠cio
            </button>
            <p class="text-center text-gray-600 mb-8">
                Calcule a expectativa do seu sistema ou estrat√©gia de trading.
            </p>

            <!-- Strategy Input Form -->
            <div class="mb-10 p-6 bg-blue-50 rounded-lg shadow-md">
                <h2 class="text-2xl font-bold text-blue-700 mb-5 text-center">Dados de Entrada</h2>
                <div class="grid grid-cols-1 gap-6">
                    <div>
                        <label for="expectativaAvgProfitInput" class="block text-sm font-medium text-gray-700 mb-1">Lucro M√©dio (Recompensa m√©dia em $ ou pips)</label>
                        <input
                            type="number"
                            id="expectativaAvgProfitInput"
                            value="30"
                            step="0.01"
                            class="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                        />
                    </div>
                    <div>
                        <label for="expectativaAvgLossInput" class="block text-sm font-medium text-gray-700 mb-1">Perda M√©dia (Risco m√©dio em $ ou pips)</label>
                        <input
                            type="number"
                            id="expectativaAvgLossInput"
                            value="10"
                            step="0.01"
                            class="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                        />
                    </div>
                    <div>
                        <label for="expectativaWinRateInput" class="block text-sm font-medium text-gray-700 mb-1">Taxa de Acerto (%)</label>
                        <input
                            type="number"
                            id="expectativaWinRateInput"
                            value="40"
                            step="0.01"
                            class="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                        />
                        <p class="text-xs text-gray-500 mt-1">Percentual de opera√ß√µes que voc√™ fecha no lucro com seu sistema ou estrat√©gia</p>
                    </div>
                </div>
                <button
                    id="expectativa-calculate-button"
                    class="mt-8 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition duration-300 ease-in-out transform hover:scale-105"
                >
                    Calcular Expectativa
                </button>
            </div>

            <!-- Evaluation Results Section -->
            <div id="expectativa-results-section" class="hidden mb-10 p-6 bg-green-50 rounded-lg shadow-md">
                <h2 class="text-2xl font-bold text-green-700 mb-5 text-center">Resultados da Avalia√ß√£o</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="p-4 rounded-lg shadow-sm flex flex-col items-center justify-center text-center bg-white">
                        <p class="text-sm font-medium text-gray-700">R/R Ratio</p>
                        <p id="expectativaRrRatioDisplay" class="text-2xl font-bold text-blue-600 mt-1">0.00</p>
                    </div>
                    <div class="p-4 rounded-lg shadow-sm flex flex-col items-center justify-center text-center bg-white">
                        <p class="text-sm font-medium text-gray-700">Expectativa do Sistema/Estrat√©gia</p>
                        <p id="expectativaExpectancyDisplay" class="text-2xl font-bold text-purple-600 mt-1">0.00%</p>
                    </div>
                </div>
                <p class="text-center text-gray-600 mt-6">
                    Essa √© uma calculadora b√°sica de expectativa. Lembre-se que sucesso no passado n√£o garante resultados futuros.
                </p>
                <button
                    id="expectativa-reset-button"
                    class="mt-8 w-full bg-gray-400 hover:bg-gray-500 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition duration-300 ease-in-out transform hover:scale-105"
                >
                    Redefinir
                </button>
            </div>
        </div>

        <!-- Avaliador App Section -->
        <div id="avaliador-page" class="page-content">
            <h1 class="text-4xl font-extrabold text-red-800 mb-6 text-center">
                üß† Avaliador - Controle Emocional / Pr√©-Check
            </h1>
            <button id="avaliador-btn-home" class="mb-6 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                ‚Üê Voltar ao In√≠cio
            </button>
            <p class="text-center text-gray-600 mb-8">
                Avalie o seu estado mental antes de operar.
            </p>

            <div class="container-avaliador"> <h1>Di√°rio de Trading - Controle Emocional / Pr√©-Check</h1>

                <div class="section card">
                    <h2>Pr√©-Check Di√°rio</h2>
                    <div class="input-group">
                        <label for="checkDate">Data:</label>
                        <input type="date" id="checkDate" class="input-field">
                    </div>
                    <div class="input-group">
                        <label for="humorGeral">Humor Geral:</label>
                        <select id="humorGeral" class="input-field">
                            <option value="">Selecione</option>
                            <option value="otimo">√ìtimo</option>
                            <option value="bom">Bom</option>
                            <option value="neutro">Neutro</option>
                            <option value="ruim">Ruim</option>
                            <option value="pessimo">P√©ssimo</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="nivelEstresse">N√≠vel de Estresse (1-10):</label>
                        <input type="number" id="nivelEstresse" min="1" max="10" value="5" class="input-field">
                    </div>
                    <div class="input-group">
                        <label for="sonoHoras">Horas de Sono:</label>
                        <input type="number" id="sonoHoras" min="0" step="0.5" value="7.5" class="input-field">
                    </div>
                    <div class="input-group">
                        <label for="energiaFisica">Energia F√≠sica (1-10):</label>
                        <input type="number" id="energiaFisica" min="1" max="10" value="7" class="input-field">
                    </div>
                    <div class="input-group checkbox-group">
                        <label for="confiancaEstrategia">Confiante na Estrat√©gia?</label>
                        <input type="checkbox" id="confiancaEstrategia" checked>
                    </div>
                    <div class="input-group checkbox-group">
                        <label for="focoClaro">Foco Claro para o Dia?</label>
                        <input type="checkbox" id="focoClaro" checked>
                    </div>
                    <div class="input-group checkbox-group">
                        <label for="distracoesPrevistas">Distra√ß√µes Previstas?</label>
                        <input type="checkbox" id="distracoesPrevistas">
                    </div>
                    <div class="input-group checkbox-group">
                        <label for="pressaoFinanceira">Press√£o Financeira?</label>
                        <input type="checkbox" id="pressaoFinanceira">
                    </div>
                    <div class="input-group">
                        <label for="resultadoOntem">Resultado de Ontem:</label>
                        <select id="resultadoOntem" class="input-field">
                            <option value="">N√£o operei/Selecione</option>
                            <option value="ganhei">Ganhei</option>
                            <option value="perdi">Perdi</option>
                        </select>
                    </div>
                    <div class="input-group checkbox-group" id="frustracaoOntemGroup" style="display: none;">
                        <label for="frustracaoOntem">Ainda frustrado pela perda de ontem?</label>
                        <input type="checkbox" id="frustracaoOntem">
                    </div>
                    <div class="input-group checkbox-group">
                        <label for="metaAceitavel">Meta do Dia Aceit√°vel?</label>
                        <input type="checkbox" id="metaAceitavel" checked>
                    </div>
                    <div class="input-group">
                        <label for="observacoesCheck">Observa√ß√µes Adicionais:</label>
                        <textarea id="observacoesCheck" rows="2" class="input-field"></textarea>
                    </div>
                    <button id="avaliarCheckBtn" class="btn btn-primary">Avaliar se Posso Operar</button>
                    <p class="suggestion" id="operarSugestao">Responda as perguntas para receber uma sugest√£o.</p>
                </div>
            </div>
        </div>

        <!-- Projetor App Section -->
        <div id="projetor-page" class="page-content">
            <h1 class="text-4xl font-extrabold text-yellow-800 mb-6 text-center">
                üí∞ Projetor - Proje√ß√£o de Rendimentos
            </h1>
            <button id="projetor-btn-home" class="mb-6 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                ‚Üê Voltar ao In√≠cio
            </button>
            <p class="text-center text-gray-600 mb-8">
                Calcule instantaneamente seus lucros e rendimentos com investimentos ao longo do tempo.
            </p>

            <div class="mb-10 p-6 bg-yellow-50 rounded-lg shadow-md">
                <h2 class="text-2xl font-bold text-yellow-700 mb-5 text-center">Dados para Proje√ß√£o</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="projetorEquityInput" class="block text-sm font-medium text-gray-700 mb-1">Capital Inicial ($)</label>
                        <input type="number" id="projetorEquityInput" value="1000" step="1" class="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-yellow-500 focus:border-yellow-500 sm:text-sm">
                        <p class="form-text text-muted">Insira o valor a ser investido inicialmente</p>
                    </div>
                    <div>
                        <label for="projetorPeriodTypeSelect" class="block text-sm font-medium text-gray-700 mb-1">Tipo de Per√≠odo</label>
                        <select id="projetorPeriodTypeSelect" class="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-yellow-500 focus:border-yellow-500 sm:text-sm">
                            <option value="day">Dia</option>
                            <option value="week" selected>Semana</option>
                            <option value="month">M√™s</option>
                            <option value="year">Ano</option>
                        </select>
                        <p class="form-text text-muted">Selecione o tipo de per√≠odo para proje√ß√£o</p>
                    </div>
                    <div>
                        <label for="projetorNumberOfPeriodsInput" class="block text-sm font-medium text-gray-700 mb-1">N√∫mero de Per√≠odos</label>
                        <input type="number" id="projetorNumberOfPeriodsInput" value="10" min="1" class="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-yellow-500 focus:border-yellow-500 sm:text-sm">
                        <p class="form-text text-muted">Quantos per√≠odos deseja projetar</p>
                    </div>
                    <div>
                        <label for="projetorGainPerPeriodInput" class="block text-sm font-medium text-gray-700 mb-1">Ganho por Per√≠odo (%)</label>
                        <input type="number" id="projetorGainPerPeriodInput" value="1" step="0.01" class="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-yellow-500 focus:border-yellow-500 sm:text-sm">
                        <p class="form-text text-muted">Taxa de retorno por per√≠odo selecionado</p>
                    </div>
                </div>
                <button
                    id="projetor-calculate-button"
                    class="mt-8 w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition duration-300 ease-in-out transform hover:scale-105"
                >
                    Calcular Proje√ß√£o
                </button>
            </div>

            <div id="projetor-results-section" class="mb-10 p-6 bg-blue-50 rounded-lg shadow-md hidden">
                <h2 class="text-2xl font-bold text-blue-700 mb-5 text-center">Resultados da Proje√ß√£o</h2>
                <div class="result-table-container">
                    <table id="projetorResultsTable" class="min-w-full bg-white rounded-lg shadow-md">
                        <thead>
                            <tr>
                                <th id="projetorPeriodHeader" class="py-3 px-4 text-left text-sm font-medium text-gray-700 uppercase">Per√≠odo</th>
                                <th class="py-3 px-4 text-left text-sm font-medium text-gray-700 uppercase">Capital Inicial</th>
                                <th class="py-3 px-4 text-left text-sm font-medium text-gray-700 uppercase">Ganho no per√≠odo ($)</th>
                                <th class="py-3 px-4 text-left text-sm font-medium text-gray-700 uppercase">Balan√ßo Final</th>
                                <th class="py-3 px-4 text-left text-sm font-medium text-gray-700 uppercase">Ganho Total (%)</th>
                                <th id="projetorTimeInvestedHeader" class="py-3 px-4 text-left text-sm font-medium text-gray-700 uppercase">Tempo Investido</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
                <button
                    id="projetor-reset-button"
                    class="mt-8 w-full bg-gray-400 hover:bg-gray-500 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition duration-300 ease-in-out transform hover:scale-105"
                >
                    Redefinir Projetor
                </button>
            </div>
        </div>
    </div>

    <script>
        // GLOBAL APP VERSION
        const APP_VERSION = "3";

        // Global Message Box functionality
        const messageBox = document.getElementById('message-box');
        const messageContent = document.getElementById('message-content');
        const messageOkButton = document.getElementById('message-ok-button');
        const messageCancelButton = document.getElementById('message-cancel-button');

        let currentOkCallback = () => messageBox.classList.add('hidden');
        let currentCancelCallback = () => messageBox.classList.add('hidden');

        // Enhanced showMessage function to handle alerts and confirmations
        const showMessage = (message, type = 'alert', okCallback = null, cancelCallback = null) => {
            messageContent.textContent = message;
            messageBox.classList.remove('hidden');

            if (type === 'confirm') {
                messageCancelButton.classList.remove('hidden'); // Show cancel button
                messageOkButton.textContent = 'OK'; // Ensure text is OK
                currentOkCallback = okCallback || (() => messageBox.classList.add('hidden'));
                currentCancelCallback = cancelCallback || (() => messageBox.classList.add('hidden'));
            } else { // type === 'alert' (default)
                messageCancelButton.classList.add('hidden'); // Hide cancel button
                messageOkButton.textContent = 'OK'; // Ensure text is OK
                currentOkCallback = () => messageBox.classList.add('hidden');
                currentCancelCallback = () => messageBox.classList.add('hidden'); // No action for cancel
            }
        };

        // General event listeners for the global message box buttons
        messageOkButton.addEventListener('click', () => {
            currentOkCallback();
            messageBox.classList.add('hidden'); // Always hide the message box after OK
        });

        messageCancelButton.addEventListener('click', () => {
            currentCancelCallback();
            messageBox.classList.add('hidden'); // Always hide the message box after Cancel
        });

        // --- Page Navigation Logic ---
        const homePage = document.getElementById('home-page');
        const estatisticaPage = document.getElementById('estatistica-page');
        const expectativaPage = document.getElementById('expectativa-page');
        const avaliadorPage = document.getElementById('avaliador-page');
        const projetorPage = document.getElementById('projetor-page'); // New Projetor page
        const appVersionDisplay = document.getElementById('app-version'); // Element to display version

        const btnEstatistica = document.getElementById('btn-estatistica');
        const btnExpectativa = document.getElementById('btn-expectativa');
        const btnAvaliador = document.getElementById('btn-avaliador');
        const btnProjetor = document.getElementById('btn-projetor'); // New Projetor button

        const estatisticaBtnHome = document.getElementById('estatistica-btn-home');
        const expectativaBtnHome = document.getElementById('expectativa-btn-home');
        const avaliadorBtnHome = document.getElementById('avaliador-btn-home');
        const projetorBtnHome = document.getElementById('projetor-btn-home'); // New Projetor home button


        const showPage = (pageToShow) => {
            // Deactivate all pages
            homePage.classList.remove('active');
            estatisticaPage.classList.remove('active');
            expectativaPage.classList.remove('active');
            avaliadorPage.classList.remove('active');
            projetorPage.classList.remove('active'); // Deactivate Projetor page

            // Activate the selected page
            pageToShow.classList.add('active');
            window.scrollTo(0, 0); // Scroll to top when changing pages
            
            // Initialize app-specific logic if needed
            if (pageToShow === avaliadorPage) {
                initializeAvaliador();
            } else if (pageToShow === projetorPage) {
                initializeProjetor(); // Initialize Projetor when its page is shown
            } else if (pageToShow === expectativaPage) {
                initializeExpectativa(); // Initialize Expectativa when its page is shown
            }
        };

        btnEstatistica.addEventListener('click', () => {
            showPage(estatisticaPage);
            loadTrades(); // Load estatistica data when navigating to its page
        });
        btnExpectativa.addEventListener('click', () => {
            showPage(expectativaPage);
        });
        btnAvaliador.addEventListener('click', () => {
            showPage(avaliadorPage);
        });
        btnProjetor.addEventListener('click', () => { // Event listener for new Projetor button
            showPage(projetorPage);
        });

        estatisticaBtnHome.addEventListener('click', () => {
            saveTrades(); // Save estatistica data before going home
            showPage(homePage);
        });
        expectativaBtnHome.addEventListener('click', () => showPage(homePage));
        avaliadorBtnHome.addEventListener('click', () => showPage(homePage));
        projetorBtnHome.addEventListener('click', () => showPage(homePage)); // Projetor home button event listener


        // --- Estatistica App Logic ---
        // DOM Elements - Estatistica
        const dataInput = document.getElementById('dataInput');
        const valorRiscoInput = document.getElementById('valorRiscoInput');
        const riscoRecompensaInput = document.getElementById('riscoRecompensaInput');
        const winDayInput = document.getElementById('winDayInput');
        const lossDayInput = document.getElementById('lossDayInput');
        const breakEvenDayInput = document.getElementById('breakEvenDayInput');
        const winNightInput = document.getElementById('winNightInput');
        const lossNightInput = document.getElementById('lossNightInput');
        const breakEvenNightInput = document.getElementById('breakEvenNightInput');

        const saldoCalculadoDisplay = document.getElementById('saldoCalculadoDisplay');
        const totalTradesCalculadoDisplay = document.getElementById('totalTradesCalculadoDisplay');
        const taxaAcertoCalculadoDisplay = document.getElementById('taxaAcertoCalculadoDisplay');

        const estatisticaAddEditButton = document.getElementById('estatistica-add-edit-button');
        const estatisticaCancelEditButton = document.getElementById('estatistica-cancel-edit-button');
        const estatisticaExportButton = document.getElementById('estatistica-export-button');
        const estatisticaImportInput = document.getElementById('estatistica-import-input');
        const estatisticaImportButton = document.getElementById('estatistica-import-button');
        const estatisticaResetAllButton = document.getElementById('estatistica-reset-all-button');

        const monthlySummaries = document.getElementById('monthlySummaries');
        const tradeDetailsTableBody = document.getElementById('tradeDetailsTableBody');
        const totalSummary = document.getElementById('totalSummary');

        let allTrades = [];
        let editingTradeId = null; // To store the ID of the trade being edited

        // Helper to create a local date string (YYYY-MM-DD) - GLOBAL now
        const createLocalDate = (dateString) => {
            const date = new Date(dateString);
            // Get timezone offset in milliseconds and add it to the date to get local midnight
            const userTimezoneOffset = date.getTimezoneOffset() * 60000;
            return new Date(date.getTime() + userTimezoneOffset);
        };

        // Helper to format date for display - GLOBAL now
        const formatDate = (dateString) => {
            const date = createLocalDate(dateString);
            return date.toLocaleDateString('pt-BR');
        };

        // Calculate daily metrics and saldo
        const calculateDailyMetrics = () => {
            const winDay = parseInt(winDayInput.value) || 0;
            const lossDay = parseInt(lossDayInput.value) || 0;
            const breakEvenDay = parseInt(breakEvenDayInput.value) || 0;
            const winNight = parseInt(winNightInput.value) || 0;
            const lossNight = parseInt(lossNightInput.value) || 0;
            const breakEvenNight = parseInt(breakEvenNightInput.value) || 0;

            const valorR = parseFloat(valorRiscoInput.value) || 1;
            const riscoRecompensa = parseFloat(riscoRecompensaInput.value) || 3;

            const totalTrades = winDay + lossDay + breakEvenDay + winNight + lossNight + breakEvenNight;

            let saldo = 0;
            saldo += (winDay + winNight) * riscoRecompensa * valorR; // Ganhos: +3R
            saldo -= (lossDay + lossNight) * valorR; // Perdas: -1R
            // BreakEven: 0R, so no change to saldo

            const totalWinsForRate = winDay + winNight;
            const totalLossesForRate = lossDay + lossNight;
            const totalForRate = totalWinsForRate + totalLossesForRate;
            const taxaAcerto = totalForRate > 0 ? (totalWinsForRate / totalForRate) * 100 : 0;

            saldoCalculadoDisplay.textContent = `R${saldo.toFixed(2)}`;
            saldoCalculadoDisplay.classList.toggle('text-green-600', saldo >= 0);
            saldoCalculadoDisplay.classList.toggle('text-red-600', saldo < 0);

            totalTradesCalculadoDisplay.textContent = totalTrades;
            taxaAcertoCalculadoDisplay.textContent = `${taxaAcerto.toFixed(2)}%`;
        };

        // Attach event listeners for inputs to update calculated fields
        [
            winDayInput, lossDayInput, breakEvenDayInput,
            winNightInput, lossNightInput, breakEvenNightInput,
            valorRiscoInput, riscoRecompensaInput
        ].forEach(input => {
            input.addEventListener('input', calculateDailyMetrics);
        });

        // Load trades from localStorage
        const loadTrades = () => {
            const storedTrades = localStorage.getItem('dayTradeData');
            if (storedTrades) {
                try {
                    allTrades = JSON.parse(storedTrades);
                    // Ensure all trades have robust IDs and correct date types on load
                    allTrades = allTrades.map(trade => {
                        if (!trade.id || !trade.id.includes('-')) { // Simple check for robust ID format
                            trade.id = Date.now().toString() + '-' + Math.random().toString(36).substring(2, 8);
                        }
                        if (typeof trade.data === 'string' && !trade.data.includes('T')) { // Ensure date is parsed correctly if just a date string
                             trade.data = trade.data; // Keep as string for input.value, convert when needed
                        }
                        return trade;
                    });
                } catch (e) {
                    console.error("Erro ao analisar dados da Estatistica do localStorage, a redefinir.", e);
                    allTrades = [];
                }
            } else {
                // Initial demo data if no data in localStorage
                allTrades = [
                    {
                        id: 'demo-2025-07-23',
                        data: '2025-07-23',
                        winDay: 1, lossDay: 2, breakEvenDay: 2,
                        winNight: 1, lossNight: 2, breakEvenNight: 0,
                        valorRisco: 1, riscoRecompensa: 3,
                        saldo: 2, totalTrades: 8, taxaAcerto: 33.33
                    },
                    {
                        id: 'demo-2025-07-24',
                        data: '2025-07-24',
                        winDay: 0, lossDay: 3, breakEvenDay: 0,
                        winNight: 2, lossNight: 6, breakEvenNight: 0,
                        valorRisco: 1, riscoRecompensa: 3,
                        saldo: -3, totalTrades: 11, taxaAcerto: 18.18
                    }
                ];
            }
            renderAllSummaries();
        };

        // Save trades to localStorage
        const saveTrades = () => {
            localStorage.setItem('dayTradeData', JSON.stringify(allTrades));
            renderAllSummaries();
        };

        // Add or Edit Trade
        const addOrEditTrade = () => {
            const data = dataInput.value;
            const winDay = parseInt(winDayInput.value) || 0;
            const lossDay = parseInt(lossDayInput.value) || 0;
            const breakEvenDay = parseInt(breakEvenDayInput.value) || 0;
            const winNight = parseInt(winNightInput.value) || 0;
            const lossNight = parseInt(lossNightInput.value) || 0;
            const breakEvenNight = parseInt(breakEvenNightInput.value) || 0;
            const valorRisco = parseFloat(valorRiscoInput.value) || 1;
            const riscoRecompensa = parseFloat(riscoRecompensaInput.value) || 3;

            if (!data) {
                showMessage('Por favor, selecione uma data.');
                return;
            }

            const totalTrades = winDay + lossDay + breakEvenDay + winNight + lossNight + breakEvenNight;
            if (totalTrades === 0) {
                 showMessage('Nenhuma opera√ß√£o registada para o dia. Por favor, insira pelo menos um valor.');
                 return;
            }

            const totalWinsForRate = winDay + winNight;
            const totalLossesForRate = lossDay + lossNight;
            const totalForRate = totalWinsForRate + totalLossesForRate;
            const taxaAcerto = totalForRate > 0 ? (totalWinsForRate / totalForRate) * 100 : 0;

            let saldo = (totalWinsForRate * riscoRecompensa * valorRisco) - (totalLossesForRate * valorRisco);

            const newTrade = {
                id: editingTradeId || (Date.now().toString() + '-' + Math.random().toString(36).substring(2, 8)),
                data,
                winDay, lossDay, breakEvenDay,
                winNight, lossNight, breakEvenNight,
                valorRisco, riscoRecompensa,
                saldo: parseFloat(saldo.toFixed(2)),
                totalTrades,
                taxaAcerto: parseFloat(taxaAcerto.toFixed(2))
            };

            if (editingTradeId) {
                // Update existing trade
                const tradeIndex = allTrades.findIndex(trade => trade.id === editingTradeId);
                if (tradeIndex !== -1) {
                    allTrades[tradeIndex] = newTrade;
                    showMessage('Opera√ß√£o editada com sucesso!');
                } else {
                    showMessage('Erro: Opera√ß√£o a ser editada n√£o encontrada.');
                }
            } else {
                // Add new trade, check for existing date
                const existingTradeIndex = allTrades.findIndex(trade => trade.data === data);
                if (existingTradeIndex !== -1) {
                    // Update if date exists
                    newTrade.id = allTrades[existingTradeIndex].id; // Retain existing ID
                    allTrades[existingTradeIndex] = newTrade;
                    showMessage('Opera√ß√£o para esta data atualizada com sucesso!');
                } else {
                    // Add new
                    allTrades.push(newTrade);
                    showMessage('Opera√ß√£o adicionada com sucesso!');
                }
            }

            resetForm();
            saveTrades();
        };

        const deleteTrade = (id) => {
            showMessage(
                'Tem a certeza que quer apagar esta opera√ß√£o?',
                'confirm',
                () => { // OK callback
                    const initialLength = allTrades.length;
                    allTrades = allTrades.filter(trade => trade.id !== id);
                    if (allTrades.length < initialLength) {
                        showMessage('Opera√ß√£o apagada com sucesso!');
                        saveTrades();
                    } else {
                        showMessage('Opera√ß√£o n√£o encontrada para apagar ou j√° foi removida.');
                        console.warn(`Tentativa de apagar ID: ${id}. IDs atuais:`, allTrades.map(t => t.id));
                    }
                },
                () => { // Cancel callback
                    showMessage('Opera√ß√£o de exclus√£o cancelada.');
                }
            );
        };


        const editTrade = (id) => {
            const tradeToEdit = allTrades.find(trade => trade.id === id);
            if (tradeToEdit) {
                dataInput.value = tradeToEdit.data;
                winDayInput.value = tradeToEdit.winDay;
                lossDayInput.value = tradeToEdit.lossDay;
                breakEvenDayInput.value = tradeToEdit.breakEvenDay;
                winNightInput.value = tradeToEdit.winNight;
                lossNightInput.value = tradeToEdit.lossNight;
                breakEvenNightInput.value = tradeToEdit.breakEvenNight;
                valorRiscoInput.value = tradeToEdit.valorRisco;
                riscoRecompensaInput.value = tradeToEdit.riscoRecompensa;

                editingTradeId = id; // Set the ID of the trade being edited
                estatisticaAddEditButton.textContent = 'Salvar Edi√ß√£o';
                estatisticaAddEditButton.classList.remove('bg-blue-600');
                estatisticaAddEditButton.classList.add('bg-green-600');
                estatisticaCancelEditButton.classList.remove('hidden');
                calculateDailyMetrics(); // Update calculated fields based on loaded data
                showMessage('Pode agora editar a opera√ß√£o e clicar em "Salvar Edi√ß√£o".');
            } else {
                showMessage('Opera√ß√£o n√£o encontrada para edi√ß√£o.');
            }
        };

        const cancelEdit = () => {
            resetForm();
            showMessage('Edi√ß√£o cancelada.');
        };

        const resetForm = () => {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            dataInput.value = `${year}-${month}-${day}`;

            winDayInput.value = '0';
            lossDayInput.value = '0';
            breakEvenDayInput.value = '0';
            winNightInput.value = '0';
            lossNightInput.value = '0';
            breakEvenNightInput.value = '0';
            valorRiscoInput.value = '1';
            riscoRecompensaInput.value = '3';

            saldoCalculadoDisplay.textContent = 'R0.00';
            saldoCalculadoDisplay.classList.remove('text-green-600', 'text-red-600');
            totalTradesCalculadoDisplay.textContent = '0';
            taxaAcertoCalculadoDisplay.textContent = '0.00%';

            editingTradeId = null; // Clear editing state
            estatisticaAddEditButton.textContent = 'Adicionar Opera√ß√£o';
            estatisticaAddEditButton.classList.remove('bg-green-600');
            estatisticaAddEditButton.classList.add('bg-blue-600');
            estatisticaCancelEditButton.classList.add('hidden');
        };

        const exportTrades = () => {
            if (allTrades.length === 0) {
                showMessage('N√£o h√° dados para exportar.');
                return;
            }
            const dataStr = JSON.stringify(allTrades, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'day_trade_data.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showMessage('Dados exportados com sucesso para day_trade_data.json!');
        };

        const importTrades = (event) => {
            const file = event.target.files[0];
            if (!file) {
                return;
            }
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (Array.isArray(importedData)) {
                        allTrades = importedData.map(trade => {
                            // Ensure imported trades also get robust IDs and consistent dates
                            if (!trade.id || !trade.id.includes('-')) {
                                trade.id = Date.now().toString() + '-' + Math.random().toString(36).substring(2, 8);
                            }
                            if (typeof trade.data === 'string' && !trade.data.includes('T')) {
                                trade.data = trade.data; // Keep as string, convert when needed
                            }
                            return trade;
                        });
                        saveTrades(); // Save imported data to localStorage
                        showMessage('Dados importados com sucesso!');
                    } else {
                        showMessage('Formato de ficheiro JSON inv√°lido. Esperava-se um array.');
                    }
                } catch (error) {
                    showMessage('Erro ao ler ou processar o ficheiro JSON.');
                    console.error("Erro na importa√ß√£o:", error);
                }
            };
            reader.readAsText(file);
        };

        // --- Render functions for Estatistica ---
        const renderAllSummaries = () => {
            renderMonthlySummaries();
            renderTradeDetails();
            renderTotalSummary();
        };

        const renderMonthlySummaries = () => {
            const monthlyData = {};
            allTrades.forEach(trade => {
                const date = createLocalDate(trade.data);
                const yearMonth = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;

                if (!monthlyData[yearMonth]) {
                    monthlyData[yearMonth] = {
                        totalWins: 0,
                        totalLosses: 0,
                        totalBreakEvensDay: 0, // Separate for day/night
                        totalBreakEvensNight: 0,
                        totalSaldo: 0,
                        totalTrades: 0,
                        totalWinsForRate: 0,
                        totalLossesForRate: 0
                    };
                }

                monthlyData[yearMonth].totalWins += (trade.winDay + trade.winNight);
                monthlyData[yearMonth].totalLosses += (trade.lossDay + trade.lossNight);
                monthlyData[yearMonth].totalBreakEvensDay += trade.breakEvenDay;
                monthlyData[yearMonth].totalBreakEvensNight += trade.breakEvenNight;
                monthlyData[yearMonth].totalSaldo += trade.saldo;
                monthlyData[yearMonth].totalTrades += trade.totalTrades;
                monthlyData[yearMonth].totalWinsForRate += (trade.winDay + trade.winNight);
                monthlyData[yearMonth].totalLossesForRate += (trade.lossDay + trade.lossNight);
            });

            let html = '';
            const sortedMonths = Object.keys(monthlyData).sort().reverse(); // Sort descending by month

            sortedMonths.forEach(yearMonth => {
                const monthName = new Date(yearMonth).toLocaleString('pt-BR', { month: 'long', year: 'numeric' });
                const monthSummary = monthlyData[yearMonth];
                const totalForRate = monthSummary.totalWinsForRate + monthSummary.totalLossesForRate;
                const monthlyTaxaAcerto = totalForRate > 0 ? (monthSummary.totalWinsForRate / totalForRate) * 100 : 0;

                const saldoClass = monthSummary.totalSaldo >= 0 ? 'text-green-600' : 'text-red-600';

                html += `
                    <div class="p-4 rounded-lg shadow-sm bg-white">
                        <h3 class="text-lg font-bold text-gray-800 mb-2">${monthName}</h3>
                        <p class="text-sm text-gray-700">Ganhos: ${monthSummary.totalWins}</p>
                        <p class="text-sm text-gray-700">Perdas: ${monthSummary.totalLosses}</p>
                        <p class="text-sm text-gray-700">Empates (Dia): ${monthSummary.totalBreakEvensDay}</p>
                        <p class="text-sm text-gray-700">Empates (Noite): ${monthSummary.totalBreakEvensNight}</p>
                        <p class="text-sm text-gray-700">Total Trades: ${monthSummary.totalTrades}</p>
                        <p class="text-sm text-gray-700">Taxa Acerto: ${monthlyTaxaAcerto.toFixed(2)}%</p>
                        <p class="text-lg font-semibold ${saldoClass}">Saldo: R${monthSummary.totalSaldo.toFixed(2)}</p>
                    </div>
                `;
            });
            monthlySummaries.innerHTML = html;
        };

        let currentSortColumn = 'data';
        let currentSortDirection = 'asc'; // 'asc' or 'desc'

        const renderTradeDetails = () => {
            const sortedTrades = [...allTrades].sort((a, b) => {
                let valA = a[currentSortColumn];
                let valB = b[currentSortColumn];

                if (currentSortColumn === 'data') {
                    // Convert date strings to Date objects for proper comparison
                    valA = new Date(a.data);
                    valB = new Date(b.data);
                } else if (typeof valA === 'string') {
                    valA = valA.toLowerCase();
                    valB = valB.toLowerCase();
                }

                if (valA < valB) return currentSortDirection === 'asc' ? -1 : 1;
                if (valA > valB) return currentSortDirection === 'asc' ? 1 : -1;
                return 0;
            });

            let html = '';
            sortedTrades.forEach(trade => {
                const saldoClass = trade.saldo >= 0 ? 'text-green-600' : 'text-red-600';
                html += `
                    <tr class="border-b last:border-b-0 hover:bg-gray-50">
                        <td class="py-3 px-4 whitespace-nowrap">${formatDate(trade.data)}</td>
                        <td class="py-3 px-4 text-center">${trade.winDay}</td>
                        <td class="py-3 px-4 text-center">${trade.lossDay}</td>
                        <td class="py-3 px-4 text-center">${trade.breakEvenDay}</td>
                        <td class="py-3 px-4 text-center">${trade.winNight}</td>
                        <td class="py-3 px-4 text-center">${trade.breakEvenNight}</td>
                        <td class="py-3 px-4 text-center">${trade.totalTrades}</td>
                        <td class="py-3 px-4 text-center">${trade.taxaAcerto.toFixed(2)}%</td>
                        <td class="py-3 px-4 ${saldoClass}">R${trade.saldo.toFixed(2)}</td>
                        <td class="py-3 px-4 text-center">${trade.valorRisco}</td>
                        <td class="py-3 px-4 text-center">${trade.riscoRecompensa}</td>
                        <td class="py-3 px-4">
                            <button onclick="editTrade('${trade.id}')" class="bg-blue-500 hover:bg-blue-700 text-white text-sm py-1 px-2 rounded mr-2">Editar</button>
                            <button onclick="deleteTrade('${trade.id}')" class="bg-red-500 hover:bg-red-700 text-white text-sm py-1 px-2 rounded">Apagar</button>
                        </td>
                    </tr>
                `;
            });
            tradeDetailsTableBody.innerHTML = html;

            // Update sort icons
            document.querySelectorAll('#estatistica-page th[data-sort]').forEach(header => {
                const sortIcon = header.querySelector('.sort-icon');
                if (sortIcon) sortIcon.innerHTML = '';
            });
            const activeHeader = document.querySelector(`#estatistica-page th[data-sort="${currentSortColumn}"] .sort-icon`);
            if (activeHeader) {
                activeHeader.innerHTML = currentSortDirection === 'asc' ? ' ‚Üë' : ' ‚Üì';
            }
        };

        const sortTradesByColumn = (column) => {
            if (currentSortColumn === column) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            }
            else {
                currentSortColumn = column;
                currentSortDirection = 'asc';
            }
            renderTradeDetails();
        };

        // Attach sorting event listeners to table headers
        document.querySelectorAll('#estatistica-page th[data-sort]').forEach(header => {
            header.addEventListener('click', (e) => {
                sortTradesByColumn(e.currentTarget.dataset.sort);
            });
        });


        const renderTotalSummary = () => {
            let totalWinDay = 0;
            let totalLossDay = 0;
            let totalBreakEvenDay = 0;
            let totalWinNight = 0;
            let totalLossNight = 0;
            let totalBreakEvenNight = 0;
            let totalSaldo = 0;
            let overallTotalTrades = 0;
            let totalWinsForOverallRate = 0;
            let totalLossesForOverallRate = 0;

            allTrades.forEach(trade => {
                totalWinDay += trade.winDay;
                totalLossDay += trade.lossDay;
                totalBreakEvenDay += trade.breakEvenDay;
                totalWinNight += trade.winNight;
                totalLossNight += trade.lossNight;
                totalBreakEvenNight += trade.breakEvenNight;
                totalSaldo += trade.saldo;
                overallTotalTrades += trade.totalTrades;
                totalWinsForOverallRate += (trade.winDay + trade.winNight);
                totalLossesForOverallRate += (trade.lossDay + trade.lossNight);
            });

            const totalForRate = totalWinsForOverallRate + totalLossesForOverallRate;
            const overallTaxaAcerto = totalForRate > 0 ? (totalWinsForOverallRate / totalForRate) * 100 : 0;
            const saldoClass = totalSaldo >= 0 ? 'text-green-600' : 'text-red-600';

            totalSummary.innerHTML = `
                <div class="p-4 rounded-lg shadow-sm bg-white">
                    <p class="text-sm font-medium text-gray-700">Total Ganhos (Dia):</p>
                    <p class="text-lg font-bold text-green-600 mt-1">${totalWinDay}</p>
                </div>
                <div class="p-4 rounded-lg shadow-sm bg-white">
                    <p class="text-sm font-medium text-gray-700">Total Perdas (Dia):</p>
                    <p class="text-lg font-bold text-red-600 mt-1">${totalLossDay}</p>
                </div>
                <div class="p-4 rounded-lg shadow-sm bg-white">
                    <p class="text-sm font-medium text-gray-700">Total Empates (Dia):</p>
                    <p class="text-lg font-bold text-gray-600 mt-1">${totalBreakEvenDay}</p>
                </div>
                <div class="p-4 rounded-lg shadow-sm bg-white">
                    <p class="text-sm font-medium text-gray-700">Total Ganhos (Noite):</p>
                    <p class="text-lg font-bold text-green-600 mt-1">${totalWinNight}</p>
                </div>
                <div class="p-4 rounded-lg shadow-sm bg-white">
                    <p class="text-sm font-medium text-gray-700">Total Perdas (Noite):</p>
                    <p class="text-lg font-bold text-red-600 mt-1">${totalLossNight}</p>
                </div>
                <div class="p-4 rounded-lg shadow-sm bg-white">
                    <p class="text-sm font-medium text-gray-700">Total Empates (Noite):</p>
                    <p class="text-lg font-bold text-gray-600 mt-1">${totalBreakEvenNight}</p>
                </div>
                <div class="p-4 rounded-lg shadow-sm bg-white">
                    <p class="text-sm font-medium text-gray-700">Total Geral Trades:</p>
                    <p class="text-lg font-bold text-gray-900 mt-1">${overallTotalTrades}</p>
                </div>
                <div class="p-4 rounded-lg shadow-sm bg-white">
                    <p class="text-sm font-medium text-gray-700">Taxa de Acerto Geral:</p>
                    <p class="text-lg font-bold text-blue-600 mt-1">${overallTaxaAcerto.toFixed(2)}%</p>
                </div>
                <div class="p-4 rounded-lg shadow-sm bg-white">
                    <p class="text-sm font-medium text-gray-700">Saldo Total:</p>
                    <p class="text-lg font-bold ${saldoClass} mt-1">R${totalSaldo.toFixed(2)}</p>
                </div>
            `;
        };

        const resetAllFieldsEstatistica = () => {
            showMessage(
                'Tem a certeza que quer apagar TODOS os dados da Estatistica?',
                'confirm',
                () => { // OK callback
                    allTrades = [];
                    localStorage.removeItem('dayTradeData');
                    resetForm();
                    renderAllSummaries();
                    showMessage('Todos os dados da Estatistica foram redefinidos!');
                },
                () => { // Cancel callback
                    showMessage('Redefini√ß√£o da Estatistica cancelada.');
                }
            );
        };

        // Event Listeners for Estatistica
        estatisticaAddEditButton.addEventListener('click', addOrEditTrade);
        estatisticaCancelEditButton.addEventListener('click', cancelEdit);
        estatisticaExportButton.addEventListener('click', exportTrades);
        estatisticaImportButton.addEventListener('click', () => estatisticaImportInput.click());
        estatisticaImportInput.addEventListener('change', importTrades);
        estatisticaResetAllButton.addEventListener('click', resetAllFieldsEstatistica);


        // Set default date for Estatistica input
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        dataInput.value = `${year}-${month}-${day}`;
        calculateDailyMetrics(); // Initial calculation for empty form


        // --- Expectativa App Logic ---
        // DOM Elements for Expectativa (will be retrieved inside initializeExpectativa)
        let expectativaAvgProfitInput, expectativaAvgLossInput, expectativaWinRateInput;
        let expectativaCalculateButton, expectativaResetButton, expectativaResultsSection;
        let expectativaRrRatioDisplay, expectativaExpectancyDisplay;

        const initializeExpectativa = () => {
            // Get DOM elements for Expectativa when the page is active
            expectativaAvgProfitInput = document.getElementById('expectativaAvgProfitInput');
            expectativaAvgLossInput = document.getElementById('expectativaAvgLossInput');
            expectativaWinRateInput = document.getElementById('expectativaWinRateInput');

            expectativaCalculateButton = document.getElementById('expectativa-calculate-button');
            expectativaResetButton = document.getElementById('expectativa-reset-button');
            expectativaResultsSection = document.getElementById('expectativa-results-section');

            expectativaRrRatioDisplay = document.getElementById('expectativaRrRatioDisplay');
            expectativaExpectancyDisplay = document.getElementById('expectativaExpectancyDisplay');

            // Attach event listeners for Expectativa
            expectativaCalculateButton.removeEventListener('click', calculateExpectancy); // Remove if already added
            expectativaCalculateButton.addEventListener('click', calculateExpectancy);
            expectativaResetButton.removeEventListener('click', resetAllFieldsExpectativa); // Remove if already added
            expectativaResetButton.addEventListener('click', resetAllFieldsExpectativa);

            loadExpectativaData(); // Load saved data on init
            // Call calculateExpectancy AFTER all elements are sure to be defined
            calculateExpectancy();
        };

        // Function to calculate strategy metrics based on forex-social.com logic
        const calculateExpectancy = () => {
            // Check if elements are defined before accessing their values
            if (!expectativaAvgProfitInput || !expectativaAvgLossInput || !expectativaWinRateInput ||
                !expectativaRrRatioDisplay || !expectativaExpectancyDisplay || !expectativaResultsSection) {
                console.error("Expectativa DOM elements not fully initialized. Tentando novamente em 100ms...");
                // Adicionar um pequeno atraso e tentar novamente, caso o DOM ainda n√£o esteja pronto
                setTimeout(calculateExpectancy, 100); 
                return; // Sair para evitar o erro imediato
            }

            const avgProfit = parseFloat(expectativaAvgProfitInput.value);
            const avgLoss = parseFloat(expectativaAvgLossInput.value);
            const winRatePercent = parseFloat(expectativaWinRateInput.value);

            // --- Input Validation ---
            if (isNaN(avgProfit) || avgProfit < 0) {
                showMessage('Por favor, insira um Lucro M√©dio v√°lido e n√£o negativo.');
                return;
            }
            if (isNaN(avgLoss) || avgLoss < 0) {
                showMessage('Por favor, insira uma Perda M√©dia v√°lida e n√£o negativa.');
                return;
            }
            if (isNaN(winRatePercent) || winRatePercent < 0 || winRatePercent > 100) {
                showMessage('Por favor, insira uma Taxa de Acerto v√°lida (entre 0 e 100%).');
                return;
            }

            // --- Calculations ---
            const winRate = winRatePercent / 100; // Convert percentage to decimal
            const lossRate = 1 - winRate;

            // R/R Ratio
            const rrRatio = avgLoss > 0 ? (avgProfit / avgLoss) : (avgProfit > 0 ? Infinity : 0);

            // Expectancy of the System/Strategy
            // Formula based on forex-social.com's implied logic:
            // ((WinRate * avgProfit) - (LossRate * avgLoss)) / avgLoss * 100
            let expectancy = 0;
            if (avgLoss > 0) {
                expectancy = ((winRate * avgProfit) - (lossRate * avgLoss)) / avgLoss * 100;
            } else if (avgProfit > 0) { // If avgLoss is 0 but there's avgProfit, expectancy is infinite
                expectancy = Infinity;
            }

            // --- Display Results ---
            expectativaRrRatioDisplay.textContent = rrRatio === Infinity ? 'Infinito' : rrRatio.toFixed(2);
            expectativaExpectancyDisplay.textContent = expectancy === Infinity ? 'Infinito' : `${expectancy.toFixed(2)}%`;
            expectativaExpectancyDisplay.classList.toggle('text-green-600', expectancy >= 0);
            expectativaExpectancyDisplay.classList.toggle('text-red-600', expectancy < 0);
            
            // Show results section
            expectativaResultsSection.classList.remove('hidden');

            // Save data to localStorage
            saveExpectativaData();
        };

        // Function to save strategy data to localStorage
        const saveExpectativaData = () => {
            // Check if elements are defined before accessing their values
            if (!expectativaAvgProfitInput || !expectativaAvgLossInput || !expectativaWinRateInput) {
                console.error("Expectativa input elements not initialized for saving.");
                return; // Exit if elements are not ready
            }
            const data = {
                avgProfit: expectativaAvgProfitInput.value,
                avgLoss: expectativaAvgLossInput.value,
                winRate: expectativaWinRateInput.value,
            };
            localStorage.setItem('expectativaAppData', JSON.stringify(data)); 
        };

        // Function to load strategy data from localStorage
        const loadExpectativaData = () => {
            const storedData = localStorage.getItem('expectativaAppData'); 
            if (storedData) {
                try {
                    const data = JSON.parse(storedData);
                    expectativaAvgProfitInput.value = data.avgProfit || '30';
                    expectativaAvgLossInput.value = data.avgLoss || '10';
                    expectativaWinRateInput.value = data.winRate || '40';
                } catch (e) {
                    console.error("Erro ao analisar dados da Expectativa do localStorage, a redefinir para padr√£o.", e);
                    // Fallback to default values if parsing fails
                    expectativaAvgProfitInput.value = '30';
                    expectativaAvgLossInput.value = '10';
                    expectativaWinRateInput.value = '40';
                }
            }
            // calculateExpectancy(); // This call was explicitly removed and is now in initializeExpectativa
        };

        // Function to reset all fields and hide results
        const resetAllFieldsExpectativa = () => {
            showMessage(
                'Tem a certeza que quer redefinir todos os dados da Expectativa?',
                'confirm',
                () => { // OK callback
                    // Check if elements are defined before accessing their values
                    if (!expectativaAvgProfitInput || !expectativaAvgLossInput || !expectativaWinRateInput || !expectativaResultsSection || !expectativaExpectancyDisplay) {
                        console.error("Expectativa elements not initialized for reset.");
                        return; // Exit if elements are not ready
                    }
                    expectativaAvgProfitInput.value = '30';
                    expectativaAvgLossInput.value = '10';
                    expectativaWinRateInput.value = '40';
                    expectativaResultsSection.classList.add('hidden');
                    localStorage.removeItem('expectativaAppData'); // Clear stored data
                    showMessage('Todos os campos da Expectativa foram redefinidos!');
                    calculateExpectancy(); // Recalculate with defaults after reset
                },
                () => { // Cancel callback
                    showMessage('Redefini√ß√£o da Expectativa cancelada.');
                }
            );
        };


        // Event Listeners for Expectativa - Now added in initializeExpectativa
        // expectativaCalculateButton.addEventListener('click', calculateExpectancy);
        // expectativaResetButton.addEventListener('click', resetAllFieldsExpectativa);


        // --- Avaliador App Logic ---
        let checkDateInput, humorGeralSelect, nivelEstresseInput, sonoHorasInput, energiaFisicaInput,
            confiancaEstrategiaCheckbox, focoClaroCheckbox, distracoesPrevistasCheckbox, pressaoFinanceiraCheckbox,
            resultadoOntemSelect, frustracaoOntemGroup, frustracaoOntemCheckbox, metaAceitavelCheckbox,
            observacoesCheckTextarea, avaliarCheckBtn, operarSugestaoP;

        const initializeAvaliador = () => {
            // Get elements for Avaliador (ensure they are only selected when the page is active)
            checkDateInput = document.getElementById('checkDate');
            humorGeralSelect = document.getElementById('humorGeral');
            nivelEstresseInput = document.getElementById('nivelEstresse');
            sonoHorasInput = document.getElementById('sonoHoras');
            energiaFisicaInput = document.getElementById('energiaFisica');
            confiancaEstrategiaCheckbox = document.getElementById('confiancaEstrategia');
            focoClaroCheckbox = document.getElementById('focoClaro');
            distracoesPrevistasCheckbox = document.getElementById('distracoesPrevistas');
            pressaoFinanceiraCheckbox = document.getElementById('pressaoFinanceira');
            resultadoOntemSelect = document.getElementById('resultadoOntem');
            frustracaoOntemGroup = document.getElementById('frustracaoOntemGroup');
            frustracaoOntemCheckbox = document.getElementById('frustracaoOntem');
            metaAceitavelCheckbox = document.getElementById('metaAceitavel');
            observacoesCheckTextarea = document.getElementById('observacoesCheck');
            avaliarCheckBtn = document.getElementById('avaliarCheckBtn');
            operarSugestaoP = document.getElementById('operarSugestao');

            // Attach event listeners for Avaliador
            resultadoOntemSelect.removeEventListener('change', handleResultadoOntemChange); // Remove if already added
            resultadoOntemSelect.addEventListener('change', handleResultadoOntemChange);
            avaliarCheckBtn.removeEventListener('click', evaluatePreCheck); // Remove if already added
            avaliarCheckBtn.addEventListener('click', evaluatePreCheck);

            // Set today's date
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            checkDateInput.value = `${year}-${month}-${day}`;
            
            // Initial state for frustracaoOntemGroup
            handleResultadoOntemChange();
        };

        const handleResultadoOntemChange = () => {
            if (resultadoOntemSelect.value === 'perdi') {
                frustracaoOntemGroup.style.display = 'flex';
            } else {
                frustracaoOntemGroup.style.display = 'none';
                frustracaoOntemCheckbox.checked = false; // Ensure checkbox is unchecked
            }
        };

        const evaluatePreCheck = () => {
            let score = 0; // Pontua√ß√£o para determinar se pode operar
            let reasons = []; // Motivos para a sugest√£o

            // Resetar estilo antes de aplicar novo
            operarSugestaoP.classList.remove('green', 'red', 'orange');

            // Humor Geral
            const humor = humorGeralSelect.value;
            if (humor === 'otimo' || humor === 'bom') { score += 2; }
            else if (humor === 'neutro') { score += 1; }
            else if (humor === 'ruim' || humor === 'pessimo') { reasons.push('Humor negativo'); score -= 2; }
            else { reasons.push('Humor n√£o selecionado'); }

            // N√≠vel de Estresse
            const estresse = parseInt(nivelEstresseInput.value);
            if (isNaN(estresse) || estresse < 1 || estresse > 10) { reasons.push('N√≠vel de estresse inv√°lido'); score -= 1; }
            else if (estresse >= 1 && estresse <= 3) { score += 2; }
            else if (estresse >= 4 && estresse <= 6) { score += 1; }
            else { reasons.push('N√≠vel de estresse elevado'); score -= 3; }

            // Horas de Sono
            const sono = parseFloat(sonoHorasInput.value);
            if (isNaN(sono) || sono < 0) { reasons.push('Horas de sono inv√°lidas'); score -= 1; }
            else if (sono >= 7) { score += 2; }
            else if (sono >= 5) { score += 1; }
            else { reasons.push('Poucas horas de sono'); score -= 2; }

            // Energia F√≠sica
            const energia = parseInt(energiaFisicaInput.value);
            if (isNaN(energia) || energia < 1 || energia > 10) { reasons.push('N√≠vel de energia f√≠sica inv√°lido'); score -= 1; }
            else if (energia >= 7) { score += 2; }
            else if (energia >= 4) { score += 1; }
            else { reasons.push('Baixa energia f√≠sica'); score -= 2; }

            // Confiante na Estrat√©gia
            if (confiancaEstrategiaCheckbox.checked) { score += 2; }
            else { reasons.push('Falta de confian√ßa na estrat√©gia'); score -= 3; }

            // Foco Claro
            if (focoClaroCheckbox.checked) { score += 2; }
            else { reasons.push('Foco pouco claro'); score -= 3; }

            // Distra√ß√µes Previstas
            if (distracoesPrevistasCheckbox.checked) {
                reasons.push('Distra√ß√µes previstas');
                score -= 4; // Penalidade maior
            } else { score += 1; }

            // Press√£o Financeira
            if (pressaoFinanceiraCheckbox.checked) {
                reasons.push('Press√£o financeira');
                score -= 5; // Penalidade maior
            } else { score += 1; }

            // Resultado de Ontem e Frustra√ß√£o
            const resultadoOntem = resultadoOntemSelect.value;
            if (resultadoOntem === 'perdi') {
                if (frustracaoOntemCheckbox.checked) {
                    reasons.push('Frustra√ß√£o pela perda de ontem');
                    score -= 4;
                } else {
                    score -= 1; // Perda de ontem ainda √© um ponto de aten√ß√£o, mesmo sem frustra√ß√£o
                }
            } else if (resultadoOntem === 'ganhei') {
                score += 1; // Leve positivo por ter ganho
            } else {
                score += 0; // If "N√£o operei/Selecione", no strong positive or negative score impact
            }

            // Meta Aceit√°vel
            if (metaAceitavelCheckbox.checked) { score += 2; }
            else { reasons.push('Meta do dia n√£o parece aceit√°vel/confort√°vel'); score -= 3; }

            // Sugest√£o final
            let suggestionText = '';
            if (score >= 12) { // Score ajustado para ser mais rigoroso com "Pode Operar"
                suggestionText = 'SUGEST√ÉO: SIM, PODE OPERAR. Seu estado mental parece √≥timo para trading hoje.';
                operarSugestaoP.classList.add('green');
            } else if (score >= 6) { // Score para "Cuidado"
                suggestionText = 'SUGEST√ÉO: CUIDADO. Considere operar com cautela, reduzir o risco ou fazer poucas opera√ß√µes. Motivos: ' + (reasons.length > 0 ? reasons.join(', ') : 'Nenhum motivo cr√≠tico aparente, mas aten√ß√£o.');
                operarSugestaoP.classList.add('orange');
            } else { // Score para "N√£o Operar"
                suggestionText = 'SUGEST√ÉO: N√ÉO, MELHOR N√ÉO OPERAR HOJE. Seu estado mental n√£o est√° ideal para trading. Motivos: ' + (reasons.length > 0 ? reasons.join(', ') : 'Fatores combinados desfavor√°veis.');
                operarSugestaoP.classList.add('red');
            }
            operarSugestaoP.textContent = suggestionText;
        };


        // --- Projetor App Logic ---
        let projetorEquityInput, projetorPeriodTypeSelect, projetorNumberOfPeriodsInput, projetorGainPerPeriodInput;
        let projetorCalculateButton, projetorResetButton, projetorResultsSection, projetorResultsTableBody;
        let projetorPeriodHeader, projetorTimeInvestedHeader; // New headers for dynamic text

        const initializeProjetor = () => {
            // Get DOM elements for Projetor
            projetorEquityInput = document.getElementById('projetorEquityInput');
            projetorPeriodTypeSelect = document.getElementById('projetorPeriodTypeSelect');
            projetorNumberOfPeriodsInput = document.getElementById('projetorNumberOfPeriodsInput');
            projetorGainPerPeriodInput = document.getElementById('projetorGainPerPeriodInput');
            projetorCalculateButton = document.getElementById('projetor-calculate-button');
            projetorResetButton = document.getElementById('projetor-reset-button');
            projetorResultsSection = document.getElementById('projetor-results-section');
            projetorResultsTableBody = document.querySelector('#projetorResultsTable tbody');
            projetorPeriodHeader = document.getElementById('projetorPeriodHeader');
            projetorTimeInvestedHeader = document.getElementById('projetorTimeInvestedHeader');


            // Attach event listeners
            projetorCalculateButton.removeEventListener('click', calculateProjetorProjection);
            projetorCalculateButton.addEventListener('click', calculateProjetorProjection);
            projetorResetButton.removeEventListener('click', resetProjetorFields);
            projetorResetButton.addEventListener('click', resetProjetorFields);

            // Attach input change listeners to recalculate on the fly or just update headers
            projetorEquityInput.removeEventListener('input', calculateProjetorProjection);
            projetorEquityInput.addEventListener('input', calculateProjetorProjection);
            projetorPeriodTypeSelect.removeEventListener('change', updateProjetorHeadersAndRecalculate);
            projetorPeriodTypeSelect.addEventListener('change', updateProjetorHeadersAndRecalculate);
            projetorNumberOfPeriodsInput.removeEventListener('input', calculateProjetorProjection);
            projetorNumberOfPeriodsInput.addEventListener('input', calculateProjetorProjection);
            projetorGainPerPeriodInput.removeEventListener('input', calculateProjetorProjection);
            projetorGainPerPeriodInput.addEventListener('input', calculateProjetorProjection);


            loadProjetorData(); // Load saved data on init
            updateProjetorHeaders(); // Update headers on initial load
            calculateProjetorProjection(); // Calculate on load with stored or default data
        };

        const updateProjetorHeaders = () => {
            const periodType = projetorPeriodTypeSelect.value;
            const periodLabel = periodType.charAt(0).toUpperCase() + periodType.slice(1); // Capitalize first letter

            if (projetorPeriodHeader) {
                projetorPeriodHeader.textContent = periodLabel;
            }
            if (projetorTimeInvestedHeader) {
                projetorTimeInvestedHeader.textContent = `Tempo Investido (${periodLabel})`;
            }
        };

        const updateProjetorHeadersAndRecalculate = () => {
            updateProjetorHeaders();
            calculateProjetorProjection();
        };


        const calculateProjetorProjection = () => {
            const equity = parseFloat(projetorEquityInput.value);
            const periodType = projetorPeriodTypeSelect.value; // 'day', 'week', 'month', 'year'
            const numberOfPeriods = parseInt(projetorNumberOfPeriodsInput.value);
            const gainPerPeriod = parseFloat(projetorGainPerPeriodInput.value);

            if (isNaN(equity) || equity <= 0) {
                projetorResultsSection.classList.add('hidden');
                return; // Do not show message, just hide results if inputs are invalid. User can correct inputs.
            }
            if (isNaN(numberOfPeriods) || numberOfPeriods <= 0) {
                projetorResultsSection.classList.add('hidden');
                return; // Do not show message
            }
            if (isNaN(gainPerPeriod)) {
                projetorResultsSection.classList.add('hidden');
                return; // Do not show message
            }

            let currentEquity = equity;
            let initialOverallEquity = equity;
            const projectionResults = [];

            for (let i = 1; i <= numberOfPeriods; i++) {
                const initialEquityThisPeriod = currentEquity;
                const gainAmountThisPeriod = initialEquityThisPeriod * (gainPerPeriod / 100);
                const finalEquityThisPeriod = initialEquityThisPeriod + gainAmountThisPeriod;
                const totalGainPercent = ((finalEquityThisPeriod / initialOverallEquity) - 1) * 100;

                projectionResults.push({
                    periodNumber: i,
                    initialEquity: initialEquityThisPeriod,
                    gainAmount: gainAmountThisPeriod,
                    finalEquity: finalEquityThisPeriod,
                    gainInPercent: totalGainPercent,
                    periodType: periodType // Pass period type for formatting
                });
                currentEquity = finalEquityThisPeriod;
            }
            renderProjectionTable(projectionResults);
            projetorResultsSection.classList.remove('hidden');
            saveProjetorData();
        };

        const renderProjectionTable = (results) => {
            projetorResultsTableBody.innerHTML = ''; // Clear previous results
            const formatter = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'USD' }); // Or 'BRL'

            results.forEach(item => {
                const timeInvestedText = formatTimeInvested(item.periodNumber, item.periodType);
                const row = projetorResultsTableBody.insertRow();
                row.innerHTML = `
                    <td class="py-3 px-4">${item.periodNumber}</td>
                    <td class="py-3 px-4">${formatter.format(item.initialEquity)}</td>
                    <td class="py-3 px-4">${formatter.format(item.gainAmount)}</td>
                    <td class="py-3 px-4">${formatter.format(item.finalEquity)}</td>
                    <td class="py-3 px-4">${item.gainInPercent.toFixed(2)}%</td>
                    <td class="py-3 px-4">${timeInvestedText}</td>
                `;
            });
        };

        const formatTimeInvested = (number, type) => {
            if (type === 'day') return `${number} dia${number > 1 ? 's' : ''}`;
            if (type === 'week') return `${number} semana${number > 1 ? 's' : ''}`;
            if (type === 'month') return `${number} m√™s${number > 1 ? 'es' : ''}`;
            if (type === 'year') return `${number} ano${number > 1 ? 's' : ''}`;
            return `${number} per√≠odos`; // Fallback
        };


        const saveProjetorData = () => {
            const data = {
                equity: projetorEquityInput.value,
                periodType: projetorPeriodTypeSelect.value,
                numberOfPeriods: projetorNumberOfPeriodsInput.value,
                gainPerPeriod: projetorGainPerPeriodInput.value,
            };
            localStorage.setItem('projetorAppData', JSON.stringify(data));
        };

        const loadProjetorData = () => {
            const storedData = localStorage.getItem('projetorAppData');
            if (storedData) {
                try {
                    const data = JSON.parse(storedData);
                    projetorEquityInput.value = data.equity || '1000';
                    projetorPeriodTypeSelect.value = data.periodType || 'week'; // Default to week
                    projetorNumberOfPeriodsInput.value = data.numberOfPeriods || '10';
                    projetorGainPerPeriodInput.value = data.gainPerPeriod || '1'; // Default gain per period
                } catch (e) {
                    console.error("Erro ao analisar dados do Projetor do localStorage, a redefinir para padr√£o.", e);
                    // Fallback to default values if parsing fails
                    projetorEquityInput.value = '1000';
                    projetorPeriodTypeSelect.value = 'week';
                    projetorNumberOfPeriodsInput.value = '10';
                    projetorGainPerPeriodInput.value = '1';
                }
            }
            updateProjetorHeaders(); // Update headers based on loaded/default type
            // calculateProjetorProjection(); // Moved to initializeProjetor
        };

        const resetProjetorFields = () => {
            showMessage(
                'Tem a certeza que quer redefinir todos os dados do Projetor?',
                'confirm',
                () => { // OK callback
                    projetorEquityInput.value = '1000';
                    projetorPeriodTypeSelect.value = 'week';
                    projetorNumberOfPeriodsInput.value = '10';
                    projetorGainPerPeriodInput.value = '1';
                    projetorResultsSection.classList.add('hidden');
                    localStorage.removeItem('projetorAppData');
                    updateProjetorHeaders(); // Update headers to default type
                    calculateProjetorProjection(); // Recalculate with defaults
                    showMessage('Todos os campos do Projetor foram redefinidos!');
                },
                () => { // Cancel callback
                    showMessage('Redefini√ß√£o do Projetor cancelada.');
                }
            );
        };


        // Initial load for the home page and app version display.
        window.onload = () => {
            appVersionDisplay.textContent = `Vers√£o: ${APP_VERSION}`; // Display the version
            showPage(homePage); // Start on the home page
            console.log("Sawada Trader - Script carregado com sucesso!"); // Log to confirm script loaded
        };
    </script>
</body>
</html>
